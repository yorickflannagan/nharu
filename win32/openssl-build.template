@ECHO OFF

:: ---------------------------------------------------
:: Generated by configure.vbs - EDIT AT YOUR OWN RISK!
:: ---------------------------------------------------

ECHO.
ECHO  * * * * * * * * * * * * * * * * * * * * * * * *
ECHO  OpenSSL Library
ECHO  Build under Windows
ECHO  -----------------------------------------------
ECHO  Copyleft (C) 2015 by The Crypthing Initiative
ECHO  Authors:
ECHO    diego.sohsten@caixa.gov.br
ECHO    yorick.flannagan@gmail.com
ECHO.
ECHO  * * * * * * * * * * * * * * * * * * * * * * * *
ECHO.

:: Required paths
SET _CUR=%~dp0
SET _TARGET=%~1
FOR %%i IN ("%~dp0..") DO SET "_HOME=%%~fi"
SET _SOURCE=%_CUR%openssl
SET _PREFIX=%_HOME%\dist\%_TARGET%\openssl

SET _PERL_INSTALL_PATH=__PERL_INSTALL_PATH__
SET _NASM_INSTALL_PATH=__NASM_INSTALL_PATH__
SET _VS_INSTALL_PATH=__VS_INSTALL_PATH__

:: Build
CALL "%_VS_INSTALL_PATH%VC\Auxiliary\Build\vcvarsamd64_x86.bat"
SET PATH=%_NASM_INSTALL_PATH%;%PATH%
ECHO.
ECHO  -----------------------------------------------
ECHO  Configuring OpenSSL
ECHO  -----------------------------------------------
ECHO. 
CD "%_SOURCE%"
"%_PERL_INSTALL_PATH%bin\perl.exe" Configure VC-WIN32 no-shared --prefix="%_PREFIX%" --openssldir="%_PREFIX%"
IF %ERRORLEVEL% NEQ 0 GOTO :END
ECHO.
ECHO  -----------------------------------------------
ECHO  Adjusting OpenSSL makefile
ECHO  -----------------------------------------------
ECHO. 
powershell -NoLogo -NoProfile -NonInteractive -Command "(Get-Content makefile) -replace '/MT', '/MD' | Out-File makefile"
IF %ERRORLEVEL% NEQ 0 GOTO :END
ECHO.
ECHO  -----------------------------------------------
ECHO  Building OpenSSL
ECHO  -----------------------------------------------
ECHO. 
CALL NMAKE /NOLOGO
IF %ERRORLEVEL% NEQ 0 GOTO :END
ECHO.
ECHO  -----------------------------------------------
ECHO  Testing OpenSSL
ECHO  -----------------------------------------------
ECHO. 
CALL NMAKE /NOLOGO TEST
IF %ERRORLEVEL% NEQ 0 GOTO :END
ECHO.
ECHO  -----------------------------------------------
ECHO  Installing OpenSSL
ECHO  -----------------------------------------------
ECHO. 
CALL NMAKE /NOLOGO INSTALL
IF %ERRORLEVEL% NEQ 0 GOTO :END
ECHO.
ECHO  -----------------------------------------------
ECHO  Clean-up OpenSSL
ECHO  -----------------------------------------------
ECHO. 
CALL NMAKE /NOLOGO CLEAN
IF %ERRORLEVEL% NEQ 0 GOTO :END
ECHO.
ECHO  -----------------------------------------------
ECHO  All tasks are done
ECHO  -----------------------------------------------
ECHO. 

GOTO:END

:: Clean-up
:END
SET _CUR=
SET _TARGET=
SET _HOME=
SET _PREFIX=
SET _PERL_INSTALL_PATH=
SET _NASM_INSTALL_PATH=
SET _VS_INSTALL_PATH=
SET _SOURCE=
